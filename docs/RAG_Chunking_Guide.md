# RAG 청킹(Chunking) 가이드

## 📚 목차
1. [청킹이란?](#청킹이란)
2. [청킹 파라미터](#청킹-파라미터)
3. [문서 유형별 최적 설정](#문서-유형별-최적-설정)
4. [Overlap의 중요성](#overlap의-중요성)
5. [실전 예시](#실전-예시)
6. [성능 최적화](#성능-최적화)
7. [문제 해결](#문제-해결)

---

## 청킹이란?

**청킹(Chunking)**은 긴 문서를 작은 조각으로 나누는 과정입니다.

### 왜 필요한가?

1. **임베딩 모델 제한**: 대부분의 임베딩 모델은 512 토큰 제한
2. **검색 정확도**: 작은 청크가 더 정확한 의미 매칭
3. **메모리 효율**: 전체 문서 대신 관련 청크만 로드
4. **응답 품질**: LLM에 필요한 정보만 전달

### 청킹 방식

현재 시스템은 **Sliding Window** 방식 사용:

```
원본 문서: [AAAAA BBBBB CCCCC DDDDD EEEEE]

Chunk 1: [AAAAA BBBBB]
              ↓ overlap
Chunk 2:     [BBBBB CCCCC]
                   ↓ overlap
Chunk 3:          [CCCCC DDDDD]
                        ↓ overlap
Chunk 4:               [DDDDD EEEEE]
```

---

## 청킹 파라미터

### 1. Chunk Size (청크 크기)

**정의**: 각 청크의 최대 문자 수

```python
chunk_size = 500  # 500자
```

**측정 단위**: 유니코드 문자 (한글/영문 동일)
- 한글 1자 = 1
- 영문 1자 = 1
- 공백 1개 = 1
- 특수문자 1개 = 1

**예시**:
```python
text = "경조사 규정 Policy"
len(text)  # 12 (공백 포함)
```

### 2. Overlap (중첩 크기)

**정의**: 인접 청크 간 겹치는 문자 수

```python
overlap = 100  # 100자 중첩
```

**계산 방식**:
```python
overlap_ratio = 0.2  # 20%
overlap = chunk_size × overlap_ratio
overlap = 500 × 0.2 = 100
```

### 3. Overlap Ratio (중첩 비율)

**권장 범위**: 10% ~ 30%

| 비율 | Overlap | 특징 |
|------|---------|------|
| 10% | 50자 | 빠른 처리, 문맥 단절 위험 |
| 20% | 100자 | **균형잡힌 선택** ✅ |
| 30% | 150자 | 강한 문맥 연결, 저장 공간 증가 |

---

## 문서 유형별 최적 설정

### 1. 일반 문서 (매뉴얼, 규정, 가이드)

```json
{
  "chunk_size": 500,
  "overlap": 100,
  "overlap_ratio": 0.2
}
```

**적합한 문서**:
- 회사 규정
- 업무 매뉴얼
- 정책 문서
- 가이드북

**특징**:
- ✅ 문단 단위 의미 보존
- ✅ 검색 정확도 우수
- ✅ 범용적 사용 가능

**실제 예시**:
```
경조사 규정 (1,500자)
→ Chunk 1 (0~500): "경조사 규정에 따라..."
→ Chunk 2 (400~900): "...휴가 신청은..."
→ Chunk 3 (800~1300): "...경조금 지급..."
```

---

### 2. 짧은 문서 (FAQ, 뉴스, 공지)

```json
{
  "chunk_size": 256,
  "overlap": 50,
  "overlap_ratio": 0.2
}
```

**적합한 문서**:
- FAQ 질문-답변
- 뉴스 기사
- 공지사항
- 간단한 설명

**특징**:
- ✅ 빠른 검색 속도
- ✅ 정확한 매칭
- ⚠️ 긴 문맥 손실 가능

**실제 예시**:
```
FAQ: "휴가 신청 방법은?" (200자)
→ Chunk 1: 전체 내용 (단일 청크)
```

---

### 3. 긴 문서 (논문, 보고서, 책)

```json
{
  "chunk_size": 800,
  "overlap": 160,
  "overlap_ratio": 0.2
}
```

**적합한 문서**:
- 학술 논문
- 연구 보고서
- 기술 문서
- 전자책

**특징**:
- ✅ 긴 문맥 보존
- ✅ 복잡한 개념 유지
- ⚠️ 검색 속도 느림
- ⚠️ 저장 공간 증가

**실제 예시**:
```
논문 (10,000자)
→ Chunk 1 (0~800): "서론: 연구 배경..."
→ Chunk 2 (640~1440): "...연구 방법론..."
→ Chunk 3 (1280~2080): "...실험 결과..."
```

---

### 4. 코드 문서 (API, 기술 문서)

```json
{
  "chunk_size": 512,
  "overlap": 100,
  "overlap_ratio": 0.2
}
```

**적합한 문서**:
- API 문서
- 코드 예제
- 기술 스펙
- 개발 가이드

**특징**:
- ✅ 함수/클래스 단위 보존
- ✅ 코드 블록 완전성
- ✅ 512는 대부분 LLM 최적

**실제 예시**:
```python
# API 문서 (1,000자)
→ Chunk 1: "get_user() 함수 설명..."
→ Chunk 2: "...파라미터 상세..."
→ Chunk 3: "...반환값 및 예외..."
```

---

### 5. 대화형 문서 (채팅, 인터뷰)

```json
{
  "chunk_size": 400,
  "overlap": 80,
  "overlap_ratio": 0.2
}
```

**적합한 문서**:
- 채팅 로그
- 인터뷰 기록
- 회의록
- Q&A 세션

**특징**:
- ✅ 대화 흐름 유지
- ✅ 발화자 정보 보존
- ✅ 빠른 검색

---

## Overlap의 중요성

### Overlap가 없을 때 (❌)

```
원본: "휴가 신청은 최소 7일 전에 제출해야 하며 증빙서류가 필요하다."

Chunk 1: "...휴가를 부여한다."
Chunk 2: "경조금은 결혼 시..."

문제: "휴가 신청 방법" 문장이 두 청크 사이에서 손실!
```

### Overlap가 있을 때 (✅)

```
원본: "휴가 신청은 최소 7일 전에 제출해야 하며 증빙서류가 필요하다."

Chunk 1: "...휴가를 부여한다. 휴가 신청은 최소 7일 전에..."
                              ↑ 100자 overlap
Chunk 2: "휴가 신청은 최소 7일 전에 제출해야 하며 증빙서류가 필요하다. 경조금은..."

결과: "휴가 신청" 관련 정보가 두 청크에 모두 포함!
```

### Overlap 효과

1. **문맥 연결**: 청크 경계에서 의미 단절 방지
2. **검색 정확도**: 경계 문장도 검색 가능
3. **정보 손실 방지**: 중요 정보가 분리되지 않음

### Overlap 크기 선택

| 문서 특성 | 권장 Overlap | 이유 |
|-----------|--------------|------|
| 짧은 문장 | 50-80자 | 문장 1-2개 보존 |
| 일반 문서 | 100-120자 | 문장 2-3개 보존 |
| 긴 문단 | 150-200자 | 문단 연결 보존 |

---

## 실전 예시

### 예시 1: 경조사 규정 (현재 설정)

**문서 정보**:
- 파일: 경조규정.txt
- 크기: 1,500자
- 유형: 회사 규정

**청킹 설정**:
```json
{
  "chunk_size": 500,
  "overlap": 100
}
```

**결과**:
```
총 청크 수: 13개

Chunk 1 (0~500):
"경조사 규정
제1조 (목적) 이 규정은 직원의 경조사에 대한 지원을 규정함을 목적으로 한다.
제2조 (적용범위) 본 규정은 전 직원에게 적용된다..."

Chunk 2 (400~900):
"...전 직원에게 적용된다.
제3조 (경조휴가) 직원이 결혼할 경우 3일의 휴가를 부여한다.
휴가 신청은 최소 7일 전에 제출해야 하며..."

Chunk 3 (800~1300):
"...증빙서류가 필요하다.
제4조 (경조금) 결혼 시 10만원, 사망 시 20만원을 지급한다..."
```

**검색 예시**:
```
질문: "결혼 휴가는 며칠인가요?"

검색 결과:
✅ Chunk 2: "직원이 결혼할 경우 3일의 휴가를 부여한다."
✅ Chunk 3: "...결혼 시 10만원..." (관련 정보)

답변: "결혼 시 3일의 휴가가 부여됩니다."
```

---

### 예시 2: PDF 매뉴얼

**문서 정보**:
- 파일: 업무매뉴얼.pdf
- 페이지: 7페이지
- 크기: 약 3,500자

**청킹 설정**:
```json
{
  "chunk_size": 500,
  "overlap": 100
}
```

**결과**:
```
총 청크 수: 17개

페이지별 분포:
- Page 1: 4 chunks
- Page 2: 4 chunks
- Page 3: 2 chunks
- Page 4: 3 chunks
- Page 5: 2 chunks
- Page 6: 1 chunk
- Page 7: 1 chunk
```

---

## 성능 최적화

### 1. 청크 크기와 성능

| Chunk Size | 검색 속도 | 정확도 | 저장 공간 | 권장 용도 |
|------------|-----------|--------|-----------|-----------|
| 256 | ⚡⚡⚡ 매우 빠름 | ⭐⭐⭐ 높음 | 💾 작음 | FAQ, 뉴스 |
| 500 | ⚡⚡ 빠름 | ⭐⭐⭐⭐ 매우 높음 | 💾💾 보통 | **일반 문서** ✅ |
| 800 | ⚡ 보통 | ⭐⭐⭐⭐ 매우 높음 | 💾💾💾 큼 | 논문, 보고서 |
| 1000+ | 🐌 느림 | ⭐⭐ 낮음 | 💾💾💾💾 매우 큼 | 비추천 |

### 2. Overlap과 저장 공간

```python
# 1,000자 문서 예시

# Overlap 0%
chunk_size = 500, overlap = 0
총 청크: 2개
저장 용량: 1,000자

# Overlap 20%
chunk_size = 500, overlap = 100
총 청크: 3개
저장 용량: 1,200자 (+20%)

# Overlap 30%
chunk_size = 500, overlap = 150
총 청크: 4개
저장 용량: 1,450자 (+45%)
```

**권장**: Overlap 20% (저장 공간과 성능의 균형)

### 3. 임베딩 시간

```python
# 13개 청크 임베딩 시간 (dragonkue-KoEn-E5-Tiny)

chunk_size = 256:  약 0.5초
chunk_size = 500:  약 0.8초  ✅ 현재
chunk_size = 800:  약 1.2초
chunk_size = 1000: 약 1.5초
```

---

## 문제 해결

### 문제 1: 검색 결과가 부정확함

**증상**: 관련 없는 청크가 검색됨

**원인**: 청크가 너무 큼

**해결**:
```json
{
  "chunk_size": 500 → 400,
  "overlap": 100 → 80
}
```

---

### 문제 2: 문맥이 끊김

**증상**: 답변이 불완전하거나 이상함

**원인**: Overlap이 너무 작음

**해결**:
```json
{
  "overlap": 50 → 100,
  "overlap_ratio": 0.1 → 0.2
}
```

---

### 문제 3: 임베딩이 너무 느림

**증상**: 파일 업로드 시 오래 걸림

**원인**: 청크가 너무 많음

**해결**:
```json
{
  "chunk_size": 400 → 600,
  "overlap": 80 → 120
}
```

---

### 문제 4: 저장 공간 부족

**증상**: 벡터 DB 크기가 너무 큼

**원인**: Overlap이 너무 큼

**해결**:
```json
{
  "overlap_ratio": 0.3 → 0.2,
  "overlap": 150 → 100
}
```

---

## 설정 변경 방법

### 1. 설정 파일 위치

```
~/Downloads/ai_file_folder/config/rag_config.json
```

### 2. 설정 예시

```json
{
  "chunking": {
    "default_strategy": "sliding_window",
    "strategies": {
      "sliding_window": {
        "window_size": 500,
        "overlap_ratio": 0.2
      }
    }
  }
}
```

### 3. 설정 변경 후

1. 앱 재시작
2. 기존 문서 재업로드 (새 설정 적용)
3. 검색 테스트

---

## 권장 설정 요약

### 🏆 범용 설정 (추천)

```json
{
  "chunk_size": 500,
  "overlap": 100,
  "overlap_ratio": 0.2
}
```

**장점**:
- ✅ 대부분의 문서에 적합
- ✅ 균형잡힌 성능
- ✅ 검증된 설정

---

### 📊 문서 유형별 빠른 참조

| 문서 유형 | Chunk Size | Overlap | 비고 |
|-----------|------------|---------|------|
| FAQ, 뉴스 | 256 | 50 | 빠른 검색 |
| **일반 문서** | **500** | **100** | **권장** ✅ |
| 논문, 보고서 | 800 | 160 | 긴 문맥 |
| API 문서 | 512 | 100 | LLM 최적 |
| 채팅 로그 | 400 | 80 | 대화 흐름 |

---

## 참고 자료

### 관련 파일

- `core/rag/chunking/sliding_window_chunker.py`: 청킹 구현
- `core/rag/chunking/chunking_factory.py`: 청킹 전략 선택
- `~/Downloads/ai_file_folder/config/rag_config.json`: 설정 파일

### 추가 문서

- [RAG 시스템 개요](./RAG_Overview.md)
- [임베딩 모델 가이드](./Embedding_Models.md)
- [벡터 검색 최적화](./Vector_Search_Optimization.md)

---

**작성일**: 2025-11-11  
**버전**: 1.0  
**작성자**: Chat AI Agent Team
