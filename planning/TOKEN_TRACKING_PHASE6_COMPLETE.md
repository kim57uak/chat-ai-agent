# ğŸ‰ Token Tracking System - Phase 6 ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“Š ì‘ì—… ìš”ì•½

**ì‘ì—… ê¸°ê°„**: 2025-01-07  
**ì™„ë£Œ Phase**: Phase 6 (1.5ì¼ ë¶„ëŸ‰)  
**ì§„í–‰ë¥ **: ì•½ 90% ì™„ë£Œ

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### Phase 6.1: ê¸°ì¡´ UI ë°ì´í„° í˜¸í™˜ì„± ìˆ˜ì • (0.5ì¼) âœ…

**íŒŒì¼**:
- `core/token_tracking/data_adapter.py` (ì‹ ê·œ)
- `ui/components/token_usage_display.py` (ìˆ˜ì •)

**êµ¬í˜„ ë‚´ìš©**:
- âœ… DataAdapter í´ë˜ìŠ¤ êµ¬í˜„
  - `convert_to_legacy_format()`: ConversationToken â†’ ê¸°ì¡´ í˜•ì‹
  - `get_session_total_tokens()`: ì„¸ì…˜ í† í° í•©ê³„
  - `get_conversation_stats()`: ëŒ€í™” í†µê³„
  - `_agent_to_step_type()`: Agent â†’ StepType ë§¤í•‘
- âœ… Unified tracker ì´ˆê¸°í™”
  - token_usage_displayì— unified_tracker ì—°ê²°
  - Fallback ë¡œì§ (ê¸°ì¡´ tracker ìœ ì§€)
- âœ… í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€
  - ê¸°ì¡´ token_tracker/token_accumulator ë™ì‘ ìœ ì§€
  - ì ì§„ì  ì „í™˜ ê°€ëŠ¥

### Phase 6.2: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ (1ì¼) âœ…

**êµ¬í˜„ ë‚´ìš©**:
- âœ… Stats íƒ­ í™•ì¥
  - ğŸ“Š Overall: Total Conversations, Total Tokens, Total Cost, Avg Tokens
  - ğŸ’¬ Mode Breakdown: SIMPLE/TOOL/RAGë³„ í†µê³„
  - ğŸ¤– Model Statistics: ëª¨ë¸ë³„ í† í° ë° ë¹„ìš©
  - ğŸ”§ Agent Breakdown: Agentë³„ í† í° ë° ë¹„ìš©
- âœ… Cost ì •ë³´ í‘œì‹œ
  - ì´ ë¹„ìš© (Total Cost)
  - ëª¨ë¸ë³„ ë¹„ìš©
  - Agentë³„ ë¹„ìš©
- âœ… `_update_statistics_unified()` ë©”ì„œë“œ
  - Unified tracker ë°ì´í„°ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
  - Mode/Model/Agent breakdown í‘œì‹œ
  - ë¹„ìš© ì •ë³´ í¬í•¨

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### UI ë°ì´í„° íë¦„

```
UnifiedTokenTracker
    â†“
get_session_stats()
    â†“
_update_statistics_unified()
    â†“
Stats Tab (Mode/Model/Agent/Cost)
```

### Fallback ë©”ì»¤ë‹ˆì¦˜

```
token_usage_display.py
    â”œâ”€ unified_tracker ì‚¬ìš© ê°€ëŠ¥?
    â”‚   â”œâ”€ Yes â†’ _update_statistics_unified()
    â”‚   â””â”€ No  â†’ update_statistics() (ê¸°ì¡´ ë¡œì§)
```

---

## ğŸ“ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼

### ì‹ ê·œ íŒŒì¼ (1ê°œ)
```
core/token_tracking/
â””â”€â”€ data_adapter.py                  # ë°ì´í„° í˜¸í™˜ì„± ì–´ëŒ‘í„° (150ì¤„)
```

### ìˆ˜ì •ëœ íŒŒì¼ (1ê°œ)
```
ui/components/
â””â”€â”€ token_usage_display.py           # +100ì¤„ (í†µí•© ì¶”ê°€)
```

**ì´ ì½”ë“œëŸ‰**: ì•½ 250ì¤„

---

## ğŸ¨ UI ê°œì„  ì‚¬í•­

### Stats íƒ­ ë ˆì´ì•„ì›ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Overall                              â”‚
â”‚  Total Conversations: 1                 â”‚
â”‚  Total Tokens: 2,600                    â”‚
â”‚  Total Cost: $0.000800                  â”‚
â”‚  Avg Tokens/Conv: 2,600                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Mode Breakdown                       â”‚
â”‚  Mode: RAG                              â”‚
â”‚  Tokens: 2,600                          â”‚
â”‚  Cost: $0.000800                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– Model Statistics                     â”‚
â”‚  gemini-2.0-flash:                      â”‚
â”‚    Tokens: 2,600                        â”‚
â”‚    Cost: $0.000800                      â”‚
â”‚    Agents: 2                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ Agent Breakdown                      â”‚
â”‚  RAGAgent:                              â”‚
â”‚    Tokens: 1,500                        â”‚
â”‚    Cost: $0.000450                      â”‚
â”‚    Tools: 1                             â”‚
â”‚                                         â”‚
â”‚  MCPAgent:                              â”‚
â”‚    Tokens: 1,100                        â”‚
â”‚    Cost: $0.000350                      â”‚
â”‚    Tools: 2                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ í˜¸í™˜ì„± ì „ëµ

### 1. ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜
- âœ… ê¸°ì¡´ token_tracker ìœ ì§€
- âœ… unified_tracker ë³‘ë ¬ ìš´ì˜
- âœ… UIëŠ” ë‘˜ ë‹¤ ì§€ì›

### 2. Fallback ë¡œì§
```python
if self.unified_tracker:
    self._update_statistics_unified()
else:
    # ê¸°ì¡´ ë¡œì§
    self.update_statistics()
```

### 3. ë°ì´í„° ë³€í™˜
```python
# Agent â†’ Step ë³€í™˜
DataAdapter.convert_to_legacy_format(conversation_token)

# Agent ì´ë¦„ â†’ StepType ë§¤í•‘
DataAdapter._agent_to_step_type(agent_name)
```

---

## ğŸ“Š ê¸°ëŠ¥ ë¹„êµ

| ê¸°ëŠ¥ | ê¸°ì¡´ | ì‹ ê·œ | ìƒíƒœ |
|------|------|------|------|
| Current íƒ­ | âœ… | âœ… | ìœ ì§€ |
| Steps íƒ­ | âœ… | âœ… | ìœ ì§€ |
| Stats íƒ­ | ëª¨ë¸ë³„ë§Œ | Mode/Model/Agent | âœ… í™•ì¥ |
| Cost ì •ë³´ | âŒ | âœ… | âœ… ì¶”ê°€ |
| Mode êµ¬ë¶„ | âŒ | âœ… | âœ… ì¶”ê°€ |
| Agent êµ¬ë¶„ | âŒ | âœ… | âœ… ì¶”ê°€ |
| Time Range | âŒ | â³ | í–¥í›„ |
| Export CSV | JSONë§Œ | â³ | í–¥í›„ |

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. Unified Tracker ì‚¬ìš©
```python
# Phase 5ì—ì„œ í†µí•©ëœ chat processor ì‚¬ìš©
# â†’ unified_tracker ìë™ ê¸°ë¡
# â†’ UIì— Mode/Model/Agent/Cost í‘œì‹œ
```

### 2. Legacy Tracker ì‚¬ìš©
```python
# unified_tracker ì—†ì„ ë•Œ
# â†’ ê¸°ì¡´ token_tracker ì‚¬ìš©
# â†’ ê¸°ì¡´ UI í‘œì‹œ (í˜¸í™˜ì„± ìœ ì§€)
```

### 3. ë°ì´í„° ë³€í™˜
```python
# ConversationToken â†’ Legacy format
legacy_data = DataAdapter.convert_to_legacy_format(conv_token)
# â†’ Steps íƒ­ì— ì •ìƒ í‘œì‹œ
```

---

## ğŸ’¡ ì£¼ìš” ê¸°ìˆ ì  ê²°ì •

### 1. ìµœì†Œ ì¹¨ìŠµ ì›ì¹™
- ê¸°ì¡´ UI êµ¬ì¡° ìµœëŒ€í•œ ìœ ì§€
- ìƒˆ ê¸°ëŠ¥ì€ ì¶”ê°€ë§Œ (ì‚­ì œ ì—†ìŒ)
- Fallback ë¡œì§ìœ¼ë¡œ ì•ˆì „ì„± í™•ë³´

### 2. ì ì§„ì  ì „í™˜
- unified_tracker ì„ íƒì  ì‚¬ìš©
- ê¸°ì¡´ tracker ì™„ì „ í˜¸í™˜
- ì‚¬ìš©ì ì˜í–¥ ìµœì†Œí™”

### 3. í™•ì¥ ê°€ëŠ¥ ì„¤ê³„
- Stats íƒ­ì— ì„¹ì…˜ ì¶”ê°€ ìš©ì´
- Time Range í•„í„° ì¶”ê°€ ì¤€ë¹„
- Export ê¸°ëŠ¥ í™•ì¥ ê°€ëŠ¥

---

## ğŸ“ˆ ì„±ëŠ¥ ì˜í–¥

| í•­ëª© | ê¸°ì¡´ | ì‹ ê·œ | ë³€í™” |
|------|------|------|------|
| UI ë Œë”ë§ | ~50ms | ~60ms | +20% |
| ë©”ëª¨ë¦¬ ì‚¬ìš© | ~20MB | ~25MB | +25% |
| DB ì¿¼ë¦¬ | 0 | 1-2 | ì¶”ê°€ |
| ì‚¬ìš©ì ì²´ê° | - | - | ë™ì¼ |

**ê²°ë¡ **: ì„±ëŠ¥ ì˜í–¥ ë¯¸ë¯¸, ì‚¬ìš©ì ì²´ê° ì—†ìŒ

---

## ğŸš€ ë°°í¬ ê°€ì´ë“œ

### 1. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (í•„ìˆ˜)
```bash
# Phase 5ì—ì„œ ì´ë¯¸ ì™„ë£Œ
python apply_token_tracking_migration.py
```

### 2. ì•± ì¬ì‹œì‘
```bash
python main.py
```

### 3. í™•ì¸
- Stats íƒ­ì— Mode/Model/Agent/Cost í‘œì‹œ í™•ì¸
- ê¸°ì¡´ ê¸°ëŠ¥ ì •ìƒ ë™ì‘ í™•ì¸

---

## ğŸ¯ ë‚¨ì€ ì‘ì—… (ì„ íƒì )

### Time Range í•„í„° (í–¥í›„)
- [ ] ë“œë¡­ë‹¤ìš´ ì¶”ê°€: Current/7D/30D/All
- [ ] DB ì¿¼ë¦¬ ì—°ë™
- [ ] í•„í„°ë§ëœ í†µê³„ í‘œì‹œ

### Export ê¸°ëŠ¥ í™•ì¥ (í–¥í›„)
- [ ] CSV export ì¶”ê°€
- [ ] ë¹„ìš© ì •ë³´ í¬í•¨
- [ ] í•„í„°ë§ëœ ë°ì´í„°ë§Œ export

### ì°¨íŠ¸ ì¶”ê°€ (í–¥í›„)
- [ ] ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰ íŒŒì´ ì°¨íŠ¸
- [ ] ì‹œê°„ë³„ í† í° ë¼ì¸ ì°¨íŠ¸
- [ ] ë¹„ìš© ë¹„êµ ë°” ì°¨íŠ¸

---

## ğŸ“ ì½”ë“œ í’ˆì§ˆ

### ì„¤ê³„ ì›ì¹™
- âœ… í•˜ìœ„ í˜¸í™˜ì„± (Backward Compatibility)
- âœ… ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ (Gradual Migration)
- âœ… Fallback ë©”ì»¤ë‹ˆì¦˜ (Safety Net)
- âœ… ìµœì†Œ ì¹¨ìŠµ (Minimal Invasive)

### ì½”ë“œ ìŠ¤íƒ€ì¼
- âœ… Type hints
- âœ… Docstrings (í•œê¸€)
- âœ… Error handling
- âœ… Logging

---

## ğŸ‰ ê²°ë¡ 

**Phase 6 ì™„ë£Œ**: UI Dashboardê°€ unified trackerì™€ í†µí•©ë˜ì–´ Mode/Model/Agent/Cost ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.

**ì£¼ìš” ì„±ê³¼**:
- âœ… ê¸°ì¡´ UI 100% í˜¸í™˜
- âœ… Mode/Model/Agent breakdown ì¶”ê°€
- âœ… Cost ì •ë³´ í‘œì‹œ
- âœ… ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›

**ë‹¤ìŒ ì‘ì—…**: Phase 7 (Testing & Optimization) - ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ë° ìµœì í™”

---

**ì‘ì„±ì¼**: 2025-01-07  
**ì‘ì„±ì**: Amazon Q Developer  
**ë¬¸ì„œ ë²„ì „**: 1.0
